---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include=FALSE, echo=FALSE,message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%")
```
# rFIA: Unlocking the FIA Database in R <a href='https://rfia.netlify.app'><img src='man/figures/logo.PNG' align="right" height="139" /></a>

[![CRAN](https://www.r-pkg.org/badges/version/rFIA)](https://CRAN.R-project.org/package=rFIA)
[![Codecov test coverage](https://codecov.io/gh/doserjef/rFIA/branch/main/graph/badge.svg)](https://app.codecov.io/gh/doserjef/rFIA?branch=main)


![US Biomass](man/figures/usBiomass.jpg)

**`rFIA` is coming back online!** After a couple years of limited support and functioning of `rFIA`, `rFIA` is now being maintained and further developed by Jeff Doser and the [Statistical Ecology and Forest Science Lab](https://doserlab.com/) at North Carolina State University. We are in the process of actively updating the package, ensuring its compatibility with recent updates in FIA databases, and making other minor changes before the package is uploaded back onto CRAN. 

The package remains in active development, as we are extensively testing and updating all previous FIA functions. Below is a list of our progress in updating the existing functionality of rFIA. Once completed, we will get `rFIA` back onto CRAN and continue with numerous exciting avenues of future development... Stay tuned! 

<br>

## Functionality and update progress

Functionality is currently being updated and extensively tested. Some previous `rFIA` functionality is not yet available again, but we intend to have all previous functionality restored shortly. Below lists the functionality currently implemented and available for use if installing the GitHub version of this package. 

|`rFIA` Function  | Description                                                          | Updated |
|---------------- |----------------------------------------------------------------------| --------|
|`area()`         | Estimate land area in various classes                                | &#x2611;|
|`areaChange()`   | Estimate annual change in land area in various classes               |         |
|`biomass()`      | Estimate biomass and carbon stocks of standing trees                 | &#x2611;|
|`carbon()`       | Estimate carbon stocks by IPCC forest carbon pools                   |
|`customPSE()`    | Estimate custom variables                                            | &#x2611;|
|`clipFIA()`      | Spatial & temporal queries for FIA data                              | &#x2611;|
|`diversity()`    | Estimate diversity indices (e.g. species diversity)                  | &#x2611;|
|`dwm()`          | Estimate volume, biomass, and carbon stocks of down woody material   | &#x2611;|
|`fsi()`          | Estimate forest stability index for live tree populations            |
|`getDesignInfo()`| Summarize attributes of FIA's post-stratified inventories            | &#x2611;|
|`getFIA()`       | Download FIA data, load into R, and optionally save to disk          | &#x2611;|
|`growMort()`     | Estimate recruitment, mortality, and harvest rates                   | &#x2611;|
|`intersectFIA()` | Join attributes of a spatial polygon(s) to FIA's PLOT table          | &#x2611;|
|`invasive()`     | Estimate areal coverage of invasive species                          | &#x2611;|
|`plotFIA()`      | Produce static & animated plots of FIA summaries                     | &#x2611;|
|`readFIA()`      | Load FIA database into R environment from disk                       | &#x2611;|
|`seedling()`     | Estimate seedling abundance (TPA)                                    | &#x2611;|
|`standStruct()`  | Estimate forest structural stage distributions                       | &#x2611;|
|`tpa()`          | Estimate abundance of standing trees (TPA & BAA)                     | &#x2611;|
|`vitalRates()`   | Estimate live tree growth rates                                      | &#x2611;|
|`volume()`       | Estimate merchantable volume of standing trees                       | &#x2611;|
|`writeFIA()`     | Write in-memory FIA Database to disk                                 | &#x2611;|

<br>


The goal of `rFIA` is to increase the accessibility and use of the USFS Forest Inventory and Analysis (FIA) Database by providing a user-friendly, open source platform to easily query and analyze FIA Data. Designed to accommodate a wide range of potential user objectives, `rFIA` simplifies the estimation of forest variables from the FIA Database and allows all R users (experts and newcomers alike) to unlock the flexibility and potential inherent to the Enhanced FIA design.

Specifically, `rFIA` improves accessibility to the spatio-temporal estimation capacity of the FIA Database by producing space-time indexed summaries of forest variables within user-defined population boundaries. Direct integration with other popular R packages (e.g., dplyr, sp, and sf) facilitates efficient space-time query and data summary, and supports common data representations and API design. The package implements design-based estimation procedures outlined by Bechtold & Patterson (2005), and has been validated against estimates and sampling errors produced by EVALIDator. 

For more information and example usage of `rFIA`, check out our [website](https://rfia.netlify.app/). To report a bug or suggest additions to `rFIA`, please use our [active issues](https://github.com/doserjef/rFIA_tmp/issues) page here on GitHub, or contact [Jeff Doser](https://doserlab.com/) (maintainer). 

_**To cite**_ `rFIA`, please refer to the publication in [Environmental Modeling and Software](https://doi.org/10.1016/j.envsoft.2020.104664) (doi: https://doi.org/10.1016/j.envsoft.2020.104664).


<br>

## Installation

**`rFIA` has been off of CRAN since March 2023. Maintenance has started back up in September 2024 and we hope to have the package up on CRAN soon.**

<!-- You can install the released version of `rFIA` from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("rFIA") -->
<!-- ``` -->

Currently, you can install the development version from GitHub:

```r
devtools::install_github('doserjef/rFIA_tmp')
```


## Example Usage

### _Download FIA Data and Load into R_
The first step to using `rFIA` is to download subsets of the FIA Database. The easiest way to accomplish this is using `getFIA()`. Using one line of code, you can download state subsets of the FIA Database, load data into your R environment, and optionally save those data to a local directory for future use!

```{r eval = FALSE}
# Download the state FIA data from Connecticut (requires an internet connection)
# All data acquired from FIA Datamart: https://apps.fs.usda.gov/fia/datamart/datamart.html
ct <- getFIA(states = 'CT', dir = '/path/to/save/data')
```

By default, `getFIA()` only loads the portions of the database required to produce summaries with other `rFIA` functions (`common = TRUE`). This conserves memory on your machine and speeds download time. If you would like to download all available tables for a state, simple specify `common = FALSE` in the call to `getFIA()`.

**But what if I want to load multiple states worth of FIA data into R?** No problem! Simply specify multiple state abbreviations in the `states` argument of `getFIA()` (e.g. `states = c('MI', 'IN', 'WI', 'IL'`)), and all state subsets will be downloaded and merged into a single `FIA.Database` object. This will allow you to use other `rFIA()` functions to produce estimates within polygons which straddle state boundaries!

Note: given the massive size of the full FIA Database, users are cautioned to only download the subsets containing their region of interest.

**If you have previously downloaded FIA data and would simply like to load the data into R from a local directory, use `readFIA()`:**
```{r eval = FALSE}
# Load FIA Data from a local directory
db <- readFIA('/path/to/your/directory/')
```

----

### _Compute Estimates of Forest Variables_

Now that you have loaded your FIA data into R, it's time to put it to work. Let's explore the basic functionality of `rFIA` with `tpa()`, a function to compute tree abundance estimates (trees per acre (TPA) and basal area per acre (BAA)) from FIA data, and `fiaRI`, a subset of the FIA Database for Rhode Island including inventories from 2013-2018. 

**Estimate the abundance of live trees in Rhode Island:**
```{r warning= FALSE, message=FALSE, fig.width = .5, fig.height=.5}
library(rFIA)
# Load the Rhode Island subset of the FIADB (included w/ rFIA)
# NOTE: This object can be produced using getFIA and/or readFIA
data("fiaRI")

# Only estimates for the most recent inventory year
fiaRI_MR <- clipFIA(fiaRI, mostRecent = TRUE) 
tpaRI_MR <- tpa(fiaRI_MR)
head(tpaRI_MR)

# All Inventory Years Available (i.e., returns a time series)
tpaRI <- tpa(fiaRI)
head(tpaRI)
```

**What if I want to group estimates by species? How about by size class?**
```{r warning= FALSE, message=FALSE, height=4.5}
# Group estimates by species
tpaRI_species <- tpa(fiaRI_MR, bySpecies = TRUE)
head(tpaRI_species, n = 3)

# Group estimates by size class
# NOTE: Default 2-inch size classes, but you can make your own using makeClasses()
tpaRI_sizeClass <- tpa(fiaRI_MR, bySizeClass = TRUE)
head(tpaRI_sizeClass, n = 3)

# Group by species and size class, and plot the distribution 
# for the most recent inventory year
tpaRI_spsc <- tpa(fiaRI_MR, bySpecies = TRUE, bySizeClass = TRUE)
plotFIA(tpaRI_spsc, BAA, grp = COMMON_NAME, x = sizeClass,
        plot.title = 'Size-class distributions of BAA by species', 
        x.lab = 'Size Class (inches)', text.size = .75,
        n.max = 5) # Only want the top 5 species, try n.max = -5 for bottom 5

```

**What if I want estimates for a specific type of tree (ex. greater than 12-inches DBH and in a canopy dominant or subdominant position) in a specific area (ex. growing on mesic sites), and I want to group my estimates by some variable other than species or size class (ex. ownership group)?** 

Easy! Each of these specifications are described in the FIA Database, and all `rFIA` functions can leverage these data to easily implement complex queries!

``` {r warning = FALSE, message = FALSE}
# grpBy specifies what to group estimates by (just like species and size class above)
# treeDomain describes the trees of interest, in terms of FIA variables 
# areaDomain, just like above, describes the land area of interest
tpaRI_own <- tpa(fiaRI_MR, 
                     grpBy = OWNGRPCD, 
                     treeDomain = DIA > 12 & CCLCD %in% c(1,2),
                     areaDomain = PHYSCLCD %in% c(20:29))
head(tpaRI_own)
```

**What if I want to produce estimates within my own population boundaries (within user-defined spatial zones/polygons)?** 

This is where things get really exciting. 
``` {r warning = FALSE, message = FALSE}
# Load the county boundaries for Rhode Island. You can load your own spatial 
# data using functions in sf
data('countiesRI')

# polys specifies the polygons (zones) where you are interested in producing estimates.
# returnSpatial = TRUE indicates that the resulting estimates will be joined with the 
# polygons we specified, thus allowing us to visualize the estimates across space
tpaRI_counties <- tpa(fiaRI_MR, polys = countiesRI, returnSpatial = TRUE)

plotFIA(tpaRI_counties, BAA) # Plotting method for spatial FIA summaries, also try 'TPA' or 'TPA_PERC'
```

**We produced a really cool time series earlier, how would I marry the spatial and temporal capacity of `rFIA` to produce estimates across user-defined polygons and through time?** 

Easy! Just hand `tpa()` the full FIA.Database object you produced with `readFIA()` (not the most recent subset produced with `clipFIA()`). For stunning space-time visualizations, hand the output of `tpa()` to `plotFIA()`. To save the animation as a .gif file, simpy specify `fileName` (name of output file) and `savePath` (directory to save file, combined with `fileName`). 
```{r warning = FALSE, message=FALSE, eval = FALSE}
# Using the full FIA data set, all available inventories
tpaRI_st <- tpa(fiaRI, polys = countiesRI, returnSpatial = TRUE)

# Animate the output
library(gganimate)
plotFIA(tpaRI_st, TPA, animate = TRUE, legend.title = 'Abundance (TPA)', 
        legend.height = .8)
```
